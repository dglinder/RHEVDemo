---
- hosts: rhevm_servers
  vars:
    http_port: 80
    max_clients: 200
  remote_user: root

  tasks:
  - name: register the servers with redhat network
    rhn_register:
      state: present
      activationkey: 1-222233334444
    when: ansible_os_family == "RedHat"

  - name: upgrade all packages
    yum:
      name: *
      state: latest
    register: yum_upgrade

  - name: restart machine
    shell: sleep 2 && shutdown -r now "Ansible updates triggered"
    async: 1
    poll: 0
    sudo: true
    ignore_errors: true
    when yum_upgrade.changed

  - name: waiting for server to come back
    local_action: wait_for host={{ inventory_hostname }} state=started delay=30 timeout=300
    sudo: false
    when yum_upgrade.changed

  - name: ensure rhevm is at the latest version
    yum:
      name: rhevm
      state: latest


